<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hydrant Radar</title>
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 100%;
			width: 95%;
			max-width: 95%;
			max-height: 100%;
		}
	</style>
</head>
<body>
<div id="map" style="width: 95%; height: 100%;"></div>
<script>
	const currentPositionIcon = L.icon({
		iconUrl: 'current_position.png',
		iconSize: [38, 95],
		iconAnchor: [22, 94],
		popupAnchor: [-3, -76],
	});

	var hydrantRedIcon = L.icon({
		iconUrl: 'icon_hydrant_red.png',
		iconSize: [64, 64],
		iconAnchor: [32, 32],
		popupAnchor: [0, 0],
	});

	var hydrantRedUndergroundIcon = L.icon({
		iconUrl: 'icon_hydrant_red_underground.png',
		iconSize: [64, 64],
		iconAnchor: [32, 32],
		popupAnchor: [0, -32],
	});

	var hydrantRedPillarIcon = L.icon({
		iconUrl: 'icon_hydrant_red_pillar.png',
		iconSize: [64, 64],
		iconAnchor: [32, 32],
		popupAnchor: [0, -32],
	});

	var hydrantBlueUndergroundIcon = L.icon({
		iconUrl: 'icon_hydrant_blue_underground.png',
		iconSize: [64, 64],
		iconAnchor: [32, 32],
		popupAnchor: [0, -32],
	});

	var hydrantBluePillarIcon = L.icon({
		iconUrl: 'icon_hydrant_blue_pillar.png',
		iconSize: [64, 64],
		iconAnchor: [32, 32],
		popupAnchor: [0, -32],
	});

	const initialPosition = [49.8022, 10.1603];
	var lastUpdatedPosition = null;
	const map = L.map('map').setView(initialPosition, 19);
	const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		minZoom: 17,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);

	var items = [];
	const currentPositionMarker = L.marker(initialPosition).addTo(map);
	const distanceCircle100 = L.circle(initialPosition, {color: 'red', fillOpacity: 0.0, radius: 100}).addTo(map);
	const distanceCircle200 = L.circle(initialPosition, {color: '#FF8888', fillOpacity: 0.0, radius: 200}).addTo(map);
	const distanceCircle500 = L.circle(initialPosition, {color: '#FFC2C2', fillOpacity: 0.0, radius: 500}).addTo(map);

	function addHydrant(item) {
		var label = '';
		var itemIcon = hydrantRedIcon;

		switch(item.tags['fire_hydrant:type']) {
			case 'underground':
				label = 'Unterflurhydrant';
				itemIcon = hydrantRedUndergroundIcon;
				if(item.tags['colour'] == 'blue'){itemIcon = hydrantBlueUndergroundIcon;}
				break;
			case 'pillar':
				label = 'Ãœberflurhydrant';
				itemIcon = hydrantRedPillarIcon;
				if(item.tags['colour'] == 'blue'){itemIcon = hydrantBluePillarIcon;}
				break;
		}

		if(item.tags['fire_hydrant:diameter']) {
			label += ' ' + item.tags['fire_hydrant:diameter'] + ' mm'
		}

		L.marker([item.lat, item.lon], {title: 'label', icon: itemIcon}).addTo(map).bindPopup(label);
	}

	function updateItems(lat, lon) {
		lastUpdatedPosition = [lat, lon];
		//console.log('UPDATING for '+lat+' / '+lon);

		// Remove existing hydrants etc from map
		items.forEach((item, index) => {item.removeFrom(map);});

		// Request Overpass turbo data
		const latLonRange = 0.01;
		fetch('https://www.overpass-api.de/api/interpreter?data=[out:json];node["emergency"]('+(lat-latLonRange/2)+','+(lon-latLonRange)+','+(lat+latLonRange/2)+','+(lon+latLonRange)+');out%20meta;')
				.then(response => response.json())
				.then(response =>
						response.elements.forEach((item, index) => {
							//console.log(item);

							switch(item.tags['emergency']) {
								case 'fire_hydrant':
									addHydrant(item);
									break;
								default:
									//console.log(item.tags['emergency']);
							}
						})
				)
	}

	function positionChanged(pos) {
		const crd = pos.coords;
		//console.log(crd);

		currentPositionMarker.setLatLng([crd.latitude, crd.longitude]);
		distanceCircle100.setLatLng([crd.latitude, crd.longitude]);
		distanceCircle200.setLatLng([crd.latitude, crd.longitude]);
		distanceCircle500.setLatLng([crd.latitude, crd.longitude]);
		map.setView([crd.latitude, crd.longitude]);

		const movementLimit = 0.003;
		if(lastUpdatedPosition != null && (Math.abs(lastUpdatedPosition[0]-crd.latitude) < movementLimit || Math.abs(lastUpdatedPosition[1]-crd.longitude) < movementLimit)) {
			//console.log('skipping request because '+Math.abs(lastUpdatedPosition[0]-crd.latitude)+' / '+Math.abs(lastUpdatedPosition[1]-crd.longitude));
			return;
		}

		updateItems(crd.latitude, crd.longitude);
	}

	function positionError(err) {
		console.error(`ERROR(${err.code}): ${err.message}`);
	}

	navigator.geolocation.watchPosition(positionChanged, positionError);
</script>
</body>
</html>
